# 2.11MPEG-DASH
- [11.1简介](#11.1)
- [11.2DASH结构内容](#11.2)
- [11.3搭建DASH服务器](#11.3)

1.MPEG-DASH简介  
https://blog.csdn.net/TonyGoing/article/details/77141306  

2.自适应流媒体传输  
https://blog.csdn.net/nonmarking/article/details/85714099   


## <a id="11.1">11.1简介</a>
DASH的全称是Dynamic Adaptive Streaming over HTTP。DASH是一种新的视频传输协议，由微软、苹果、Adobe等公司共同主导完成，MPEG-DASH是一种码流自适应的技术，它可以在网络上(利用HTTP web servers)传输高质量的媒体流。其主要特点是视频切片和基于HTTP传输，可以利用现有的HTTP网络架构（专门的服务器和CDN等）传输流媒体。MPEG-DASH可以实现动态无缝适应实时的网络条件并提供高质量的播放内容，拥有更少的卡顿，极大地提升了用户体验。  
DASH整个系统可以分成服务器和客户端两个模块，视频片段的封装格式，支持MPEG-2 TS、MP4等多种格式，并且，可以使用h.265,H.264,AVS,VP9等多种编码器进行编码。服务器端通过MPD（media presentation description）文件来描述媒体信息，包括，是直播还是点播、视频切片的大小，有几种不同的码率以及每个视频片段对应的URL地址等。客户端通过MPD文件就可以知道整个将要播放的媒体信息。  
与已有的采用 RTP 的方法相比，HTTP 不需要考虑防火墙的问题，并且可以充分利用已有的系统架构，如缓存、CDN 等。DASH本身也可以通过 WebSocket 和上层 push 等技术来支持低延迟的流推送, 而且不同于 HLS、HDS 和 Smooth Streaming，DASH 不关心编解码器，因此它可以接受任何编码格式编码的内容，如 HEVC、H.264、VP9 等。由于其多方面的优势，目前全景视频也主要采用 DASH 协议进行传输，而且DASH协议针对全景视频的的特性加入了一些特定功能以适应去全景视频的传输。  

## <a id="11.2">11.2DASH结构内容</a>
MPEG-DASH传输系统架构由HTTP服务器和DASH客户端两部分组成。HTTP服务器存储着DASH文件，主要包含两部分：媒体描述文件MPD和DASH媒体文件。DASH媒体文件主要由分段媒体文件和头信息文件两部分组成。  
客户端根据实时网络情况进行下载的演示图，首先HTTP 服务器端将媒体文件切分成一个个时间长度相等的小分片，每个分片被编码为不同大小的码率；这些分片可以通过GET请求下载，客户端通过评估自身的性能和带宽情况，下载相应码率的切片。码率切换以媒体分段为单位，当网络带宽较好时，客户端可以请求对应时间较高码率的媒体分段；而当带宽变差时，客户端则下载对应码率较低的下一个媒体分段。由于不同质量的媒体分段在时间上都是相互对齐的，因此不同质量的媒体分段之间切换时，画面是自然流畅的。  
为了精确描述DASH的结构内容，MPEG-DASH引入了Media Presentation Description (MPD)的概念。MPD是一个XML文件，它完整描述了DASH内容的所有信息，包括各类音视频参数、内容分段时长、不同媒体分段的码率和分辨率以及对应的访问地址URL等等，客户端通过首先下载并解析MPD文件，可获取到与自身性能和带宽最匹配的媒体分段。下图比较清晰地说明了MPD文件的分层结构关系。  
<img src="./image/2-130.png" style="zoom:100%" />

- period
一个DASH文件可以包含一个或多个Periods，每个Period代表一段连续的视频片段，假设一段码流有60s被划分为3个Periods，Period1为0-15s，Period2为16-40s，Period3为41-60s。在同一个Period内，可用的媒体内容的类型及其各个可用码率(Representation)都不会发生变更。直播情况下，MPD文件会发生实时变化，需要周期性地去服务器请求新的MPD文件，服务器可能会移除已过时的Period，添加新的Period，而新的Period中可能会出现新的可用码率，或者移除上一个Period中存在的某些码率。  

- AdaptationSet  
 	一个Period由一个或多个AdaptationSets组成。例如，一个自适应集包含同一视频内容的多个不同比特率的视频分段，另一个自适应集包含同一音频内容的多个不同比特率的视频分段。每个AdaptationSet包含了逻辑一致的可供切换的不同码率的码流（Representation)。例如，这些Representation具有相同的codec、language、resolution以及音频通道数(5.1，stereo等)。这些Representation中可能包含一个(ISO profile)或多个(TS profile)media content components，因为ISO profile的mp4或fmp4 segment中通常只含有一个视频或者音频内容，而TS profile中的TS segment同时含有视频和音频内容，当同时含有多个media component content时，每个被复用的media content component将被单独描述。  

- Representation
 	一个AdaptationSet由一组媒体内容配置可切换的Representations构成。每个Representation表示同一媒体内容但编码参数互不相同的音视频数据。包含了相同媒体内容的不同配置，即不同的分辨率、码率等，以供客户端根据自身的网络条件和性能限制来选择合适的版本下载播放。  

- Representation
一个AdaptationSet由一组媒体内容配置可切换的Representations构成。每个Representation表示同一媒体内容但编码参数互不相同的音视频数据。包含了相同媒体内容的不同配置，即不同的分辨率、码率等，以供客户端根据自身的网络条件和性能限制来选择合适的版本下载播放。  

- Segment  
每个Representation中的内容按时间或者其他规则被切分成一段段Segments，使得客户端在播放时能够灵活地在不同的Representations之间进行切换。每个Segment都有一个唯一的与之对应的URL地址，也可能由相同的URL与不同的byte range指定。DASH客户端可以通过HTTP协议来获取URL对应的分片数据。MPD中描述Segment URL的形式包括Segment list，Segment template，Single segment。  
<img src="./image/2-131.png" style="zoom:100%" />

如图所示，DASH客户端根据MPD-URL向服务器发送请求获取MPD，客户端首先解析MPD内容，得到服务器端DASH文件的内容信息，包括视频分辨率、视频内容种类、分段情况、帧率、码率以及各个媒体内容的URL地址等媒体配置信息。DASH客户端通过分析上述DASH文件内容信息，根据当前网络状态以及客户端缓冲区的大小等选择合适的媒体版本。然后通过向服务器发送请求，根据媒体URL下载对应的媒体文件进行流式传输。客户端收到对应的媒体文件之后，进行解封装得到裸码流，最后送入解码器进行解码播放。  
Dash.js通过js基于dash的内核  

## <a id="11.3">11.3搭建DASH服务器</a>
参考链接：  
1.dash js地址  
https://www.bootcdn.cn/dashjs/   

2.dash.js  
https://github.com/Dash-Industry-Forum/dash.js    

3.构建简单的 MPEG-DASH 流媒体播放器  
https://blog.csdn.net/haima1998/article/details/38865023  

4.dash视频服务器本地搭建  
https://blog.csdn.net/weixin_30566063/article/details/98050109  

5.搭建dash直播, ffmpeg开启dash demutex  
https://www.jianshu.com/p/512cb67e35d1


过程:
1. 修改hosts, 添加:
127.0.0.1 www.testvideo.com
127.0.0.1 www.test.com
 

2. nginx配置1: (h5页面)
server {
        listen       80;
        server_name  www.test.com;

        location / {
            root    D:\server\code;
            index  index.php index.html;

        }
    }
 
nginx配置2: (视频), 重启nginx
server {
        listen       80;
        server_name  www.testvideo.com;

        location / {
            add_header Access-Control-Allow-Methods “GET,HEAD;
            add_header Accept-Ranges "bytes";
            add_header Access-Control-Allow-Origin "*";
            add_header Access-Control-Expose-Headers “Content-Lengrh,Content-Range,Date,Server,Transfer-Encoding,origin,range,x-goog-meta-foo1”;
            root    E:/video/fragment/output;

        }
    }
3. 准备HTML页面:
```js
 1 <!doctype html>
 2 <html>
 3     <head>
 4         <title>Dash.js Rocks</title>
 5         <style>
 6             video {
 7                 width: 640px;
 8                 height: 360px;
 9             }
10         </style> 
11     </head>
12     <body>
13         <div>
14             <video data-dashjs-player autoplay src="http://www.testvideo.com/stream.mpd" controls>
15             </video>
16         </div>
17         <script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script> 
18     </body>
19 </html>
20 
21 //////////////////////或者
22 <!DOCTYPE html>
23 <html lang="en">
24 <head>
25     <meta charset="utf-8"/>
26     <title>Auto-player instantiation example, single videoElement, using src attribute</title>
27     <script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>
28     <!--dash.all.min.js should be used in production over dash.all.debug.js
29         Debug files are not compressed or obfuscated making the file size much larger compared with dash.all.min.js-->
30     <!--<script src="../../dist/dash.all.min.js"></script>-->
31 
32     <style>
33         video {
34             width: 640px;
35             height: 360px;
36         }
37     </style>
38 
39     <body>
40         <div>
41             <video controls="true" id="videoPlayer" />
42         </div>
43         <script>
44             (function(){
45                 var url = "http://www.testvideo.com/stream.mpd";
46                 var player = dashjs.MediaPlayer().create();
47                 player.initialize(document.querySelector("#videoPlayer"), url, true);
48             })();
49         </script> 
50     </body>
51 </html>
```

4. 下载原始视频
选择一个mp4视频下载到本地就可以了

5. 用ffmpeg工具处理视频
先下载安装ffmpeg, 然后将ffmpeg/bin 放到环境变量中, 要不然敲命令会很麻烦
我这里只是对原始视频用 ffmpeg视频处理了一下, 没有生成很多分辨率的视频, 所以目前只有一个视频文件
ffmpeg -i xxxx.mp4

6. 用bento4继续处理视频, 这个工具会把切好的视频放到当前目录的output目录中
先下载安装bento4, 然后将bento4/bin放到环境变量中, 要不然敲命令会很麻烦
mp4dash xxxx.mp4
这条命令处理完毕后会自动生成文件夹output, 这个output文件夹要跟nginx配置2中的root指令后边的值要一致

7. 访问 http://www.test.com/index.html 应该就有视频可以播放了

## links
  * [目录](<音视频入门到精通目录.md>)
  * 下一节: [2.12HLS](<2.12HLS.md>)