# 6.2FFmpeg.md
- [FFmpeg安装](#6.1)
- [FFmpeg命令行](#6.2)
- [FFmpeg函数](#6.3)
- [FFmpeg使用注意点](#6.4)
- [Window集成ffmpeg环境搭建](#6.5)

## <a id="6.1">FFmpeg安装</a>
### 一般安装
```shell
./configure  --prefix=$PROJECT_DIR/3rdpart/ffmpeg/build \
            --prefix=/usr/local/ffmpeg 
            --enable-shared          \
            --enable-static          \
            --disable-doc
make -j4&& make install  
export PATH=$PROJECT_DIR/3rdpart/ffmpeg-4.2.2/build/bin:$PATH
export LD_LIBRARY_PATH=/home/lj/gy/MediaPlat/3rdpart/ffmpeg-4.2.2/build/lib

如果没有make install到usr/local目录下需要配置lib bin
/etc/profile  export PATH=/usr/local/ffmpeg/bin:$PATH    配置bin路径
/etc/ld.so.conf  /usr/local/ffmpeg/lib  ldconfig         配置lib路径
```

### 编译FFMpeg集成H264 H265
```shell
下载资源：
1.前往FFmpeg官方网站下载自己需要版本的FFMpeg:
https://ffmpeg.org/download.html

2.x264官方下载页:
https://www.videolan.org/developers/x264.html

3.如果下载最新版本，可以直接从如下地址获取:
ftp://ftp.videolan.org/pub/x264/snapshots/last_x264.tar.bz2

4.x265官方下载页:
https://bitbucket.org/multicoreware/x265/downloads/
```

#### 编译x264
./configure  --disable-asm --enable-shared
make -j4  
make install  

#### 编译x265
cd x265_3.1.1/source/  
cmake CMakeLists.txt  
make -j4  
make install  

#### ffmpeg编译选项
基本参数选项：  
<table><tbody><tr><td valign="top">
<p><strong><span style="color:rgb(49,132,155);">命令</span></strong></p>
</td>
<td valign="top">
<p><strong><span style="color:rgb(49,132,155);">帮助信息</span></strong></p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p>--help</p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p>显示此帮助信息<span style="font-family:Calibri;">|print this message</span></p>
</td>
</tr><tr><td valign="top">
<p>--log[=FILE|yes|no]</p>
</td>
<td valign="top">
<p>记录测试并输出到<span style="font-family:Calibri;">config.err</span><span style="font-family:'宋体';">文件</span><span style="font-family:Calibri;">|log tests and output to FILE [config.err]</span></p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p>--prefix=PREFIX</p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p>安装程序到指定目录（默认<span style="font-family:Calibri;">/usr/local</span><span style="font-family:'宋体';">）</span><span style="font-family:Calibri;">|install in PREFIX [/usr/local]</span></p>
</td>
</tr><tr><td valign="top">
<p>--libdir=DIR</p>
</td>
<td valign="top">
<p>安装库到指定目录（默认<span style="font-family:Calibri;">prefix/lib</span><span style="font-family:'宋体';">）</span><span style="font-family:Calibri;">|install libs in DIR [PREFIX/lib]</span></p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p>--shlibdir=DIR</p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p>指定共享库路径（默认<span style="font-family:Calibri;">prefix/lib</span><span style="font-family:'宋体';">）</span><span style="font-family:Calibri;">|install shared libs in DIR [PREFIX/lib]</span></p>
</td>
</tr><tr><td valign="top">
<p>--incdir=DIR</p>
</td>
<td valign="top">
<p>指定<span style="font-family:Calibri;">includes</span><span style="font-family:'宋体';">路径（默认</span><span style="font-family:Calibri;">prefix/include/ffmpeg</span><span style="font-family:'宋体';">）</span><span style="font-family:Calibri;">|install includes in DIR[PREFIX/include/ffmpeg]</span></p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p>--mandir=DIR</p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p>指定<span style="font-family:Calibri;">man page</span><span style="font-family:'宋体';">路径（默认</span><span style="font-family:Calibri;">prefix/man</span><span style="font-family:'宋体';">）</span><span style="font-family:Calibri;">install man page in DIR [PREFIX/man]</span></p>
</td>
</tr><tr><td valign="top">
<p>--enable-mp3lame</p>
</td>
<td valign="top">
<p>启用<span style="font-family:Calibri;">mp3</span><span style="font-family:'宋体';">编码</span><span style="font-family:Calibri;">libmp3lame</span><span style="font-family:'宋体';">（默认关闭）</span><span style="font-family:Calibri;">enable MP3 encoding via libmp3lame[default=no]</span></p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p>--enable-libogg</p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p>启用<span style="font-family:Calibri;">ogg</span><span style="font-family:'宋体';">支持</span><span style="font-family:Calibri;">libogg</span><span style="font-family:'宋体';">（默认关闭）</span><span style="font-family:Calibri;">enable Ogg support via libogg [default=no]</span></p>
</td>
</tr><tr><td valign="top">
<p>--enable-vorbis</p>
</td>
<td valign="top">
<p>启用<span style="font-family:Calibri;">Vorbis</span><span style="font-family:'宋体';">支持</span><span style="font-family:Calibri;">libvorbis</span><span style="font-family:'宋体';">（默认关闭）</span><span style="font-family:Calibri;">enable Vorbis support via libvorbis [default=no]</span></p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p>--enable-faad</p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p>启用<span style="font-family:Calibri;">faad</span><span style="font-family:'宋体';">支持</span><span style="font-family:Calibri;">libfaad</span><span style="font-family:'宋体';">（默认关闭）</span><span style="font-family:Calibri;">enable FAAD support via libfaad [default=no]</span></p>
</td>
</tr><tr><td valign="top">
<p>--enable-faadbin</p>
</td>
<td valign="top">
<p>启用<span style="font-family:Calibri;">faad</span><span style="font-family:'宋体';">运行时链接支持（默认关闭）</span><span style="font-family:Calibri;">build FAAD support with runtime linking[default=no]</span></p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p>--enable-faac</p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p>启用<span style="font-family:Calibri;">faac</span><span style="font-family:'宋体';">支持</span><span style="font-family:Calibri;">libfaac</span><span style="font-family:'宋体';">（默认关闭）</span><span style="font-family:Calibri;">enable FAAC support via libfaac [default=no]</span></p>
</td>
</tr><tr><td valign="top">
<p>--enable-libgsm</p>
</td>
<td valign="top">
<p>启用<span style="font-family:Calibri;">GSM</span><span style="font-family:'宋体';">支持</span><span style="font-family:Calibri;">libgsm</span><span style="font-family:'宋体';">（默认关闭）</span><span style="font-family:Calibri;">enable GSM support via libgsm [default=no]</span></p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p>--enable-xvid</p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p>启用<span style="font-family:Calibri;">xvid</span><span style="font-family:'宋体';">支持</span><span style="font-family:Calibri;">xvidcore</span><span style="font-family:'宋体';">（默认关闭）</span><span style="font-family:Calibri;">enable XviD support via xvidcore [default=no]</span></p>
</td>
</tr><tr><td valign="top">
<p><span style="color:rgb(255,0,0);">--enable-</span><span style="color:rgb(255,0,0);">lib</span><span style="color:rgb(255,0,0);">x264</span></p>
</td>
<td valign="top">
<p><span style="color:rgb(255,0,0);">启用<span style="font-family:Calibri;">H.264</span><span style="font-family:'宋体';">编码（默认关闭）</span><span style="font-family:Calibri;">enable H.264 encoding via x264 [default=no]</span></span></p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p>--enable-mingw32</p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p>启用<span style="font-family:Calibri;">MinGW</span><span style="font-family:'宋体';">本地</span><span style="font-family:Calibri;">/</span><span style="font-family:'宋体';">交叉</span><span style="font-family:Calibri;">win</span><span style="font-family:'宋体';">环境编译</span><span style="font-family:Calibri;">|enable
 MinGW native/cross Windows compile</span></p>
</td>
</tr><tr><td valign="top">
<p>--enable-mingwce</p>
</td>
<td valign="top">
<p>启用<span style="font-family:Calibri;">MinGW</span><span style="font-family:'宋体';">本地</span><span style="font-family:Calibri;">/</span><span style="font-family:'宋体';">交叉</span><span style="font-family:Calibri;">winCE</span><span style="font-family:'宋体';">环境编译</span><span style="font-family:Calibri;">enable
 MinGW native/cross WinCE compile</span></p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p>--enable-a52</p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p>启用<span style="font-family:Calibri;">A52</span><span style="font-family:'宋体';">支持（默认关闭）</span><span style="font-family:Calibri;">enable GPLed A52 support [default=no]</span></p>
</td>
</tr><tr><td valign="top">
<p>--enable-a52bin</p>
</td>
<td valign="top">
<p>启用运行时打开<span style="font-family:Calibri;">liba52.so.0</span><span style="font-family:'宋体';">（默认关闭）</span><span style="font-family:Calibri;">open liba52.so.0 at runtime [default=no]</span></p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p>--enable-dts</p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p>启用<span style="font-family:Calibri;">DTS</span><span style="font-family:'宋体';">支持（默认关闭）</span><span style="font-family:Calibri;">enable GPLed DTS support [default=no]</span></p>
</td>
</tr><tr><td valign="top">
<p>--enable-pp</p>
</td>
<td valign="top">
<p>启用后加工支持（默认关闭）<span style="font-family:Calibri;">enable GPLed postprocessing support [default=no]</span></p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p>--enable-static</p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p>构建静态库（默认启用）<span style="font-family:Calibri;">build static libraries [default=yes]</span></p>
</td>
</tr><tr><td valign="top">
<p><span style="color:rgb(255,0,0);">--disable-static</span></p>
</td>
<td valign="top">
<p><span style="color:rgb(255,0,0);">禁止构建静态库（默认关闭）<span style="font-family:Calibri;">do not build static libraries [default=no]</span></span></p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p><span style="color:rgb(255,0,0);">--enable-shared</span></p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p><span style="color:rgb(255,0,0);">构建共享库（默认关闭）<span style="font-family:Calibri;">build shared libraries [default=no]</span></span></p>
</td>
</tr><tr><td valign="top">
<p>--disable-shared</p>
</td>
<td valign="top">
<p>禁止构建共享库（默认启用）<span style="font-family:Calibri;">do not build shared libraries [default=yes]</span></p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p>--enable-amr_nb</p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p>启用<span style="font-family:Calibri;">amr_nb float</span><span style="font-family:'宋体';">音频编解码器</span><span style="font-family:Calibri;">|enable amr_nb float audio codec</span></p>
</td>
</tr><tr><td valign="top">
<p>--enable-amr_nb-fixed</p>
</td>
<td valign="top">
<p>启用<span style="font-family:Calibri;">fixed amr_nb codec | use fixed point for amr-nb codec</span></p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p>--enable-amr_wb</p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p>启用<span style="font-family:Calibri;">amr_wb float</span><span style="font-family:'宋体';">音频编解码器</span><span style="font-family:Calibri;">|enable amr_wb float audio codec</span></p>
</td>
</tr><tr><td valign="top">
<p>--enable-amr_if2</p>
</td>
<td valign="top">
<p>启用<span style="font-family:Calibri;">amr_wb IF2</span><span style="font-family:'宋体';">音频编解码器</span><span style="font-family:Calibri;">|enable amr_wb IF2 audio codec</span></p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p>--enable-sunmlib</p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p>启用<span style="font-family:Calibri;">Sun medialib</span><span style="font-family:'宋体';">（默认关闭）</span><span style="font-family:Calibri;">| use Sun medialib [default=no]</span></p>
</td>
</tr><tr><td valign="top">
<p><span style="color:rgb(255,0,0);">--enable-pthreads</span></p>
</td>
<td valign="top">
<p><span style="color:rgb(255,0,0);">启用<span style="font-family:Calibri;">pthreads</span><span style="font-family:'宋体';">（多线程）（默认关闭）</span><span style="font-family:Calibri;">use pthreads [default=no]</span></span></p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p>--enable-dc1394</p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p>启用<span style="font-family:Calibri;">libdc1394</span><span style="font-family:'宋体';">、</span><span style="font-family:Calibri;">libraw1394</span><span style="font-family:'宋体';">抓取</span><span style="font-family:Calibri;">IIDC-1394</span><span style="font-family:'宋体';">（默认关闭）</span><span style="font-family:Calibri;">enable
 IIDC-1394 grabbing using libdc1394 and libraw1394 [default=no]</span></p>
</td>
</tr><tr><td valign="top">
<p>--enable-swscaler</p>
</td>
<td valign="top">
<p>启用计数器支持？（默认关闭）<span style="font-family:Calibri;">software scaler support [default=no]</span></p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p>--enable-avisynth</p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p>允许读取<span style="font-family:Calibri;">AVISynth</span><span style="font-family:'宋体';">脚本本件（默认关闭）</span><span style="font-family:Calibri;">allow reading AVISynth script files [default=no]</span></p>
</td>
</tr><tr><td valign="top">
<p>--enable-gpl</p>
</td>
<td valign="top">
<p>允许使用<span style="font-family:Calibri;">GPL</span><span style="font-family:'宋体';">（默认关闭）</span><span style="font-family:Calibri;">allow use of GPL code, the resulting libav* and ffmpeg will be under GPL [default=no]</span></p>
</td>
</tr></tbody></table>

高级参数选项：  
<table><tbody><tr><td valign="top">
<p><strong><span style="color:rgb(49,132,155);">命令</span></strong></p>
</td>
<td valign="top">
<p><strong><span style="color:rgb(49,132,155);">帮助信息</span></strong></p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p>--source-path=PATH</p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p>源码的路径（当前为<span style="font-family:Calibri;">/root/flv/ffmpeg</span><span style="font-family:'宋体';">）</span><span style="font-family:Calibri;">| path to source code [/root/flv/ffmpeg]</span></p>
</td>
</tr><tr><td valign="top">
<p>--cross-prefix=PREFIX</p>
</td>
<td valign="top">
<p>为编译工具指定路径 <span style="font-family:Calibri;">| use PREFIX for compilation tools []</span></p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p>--cross-compile</p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p>假定使用了交叉编译 <span style="font-family:Calibri;">| assume a cross-compiler is used</span></p>
</td>
</tr><tr><td valign="top">
<p>--cc=CC</p>
</td>
<td valign="top">
<p>指定使用何种<span style="font-family:Calibri;">C</span><span style="font-family:'宋体';">编译器（默认</span><span style="font-family:Calibri;">gcc</span><span style="font-family:'宋体';">）</span><span style="font-family:Calibri;">use C compiler CC [gcc]</span></p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p>--make=MAKE</p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p>使用特定的<span style="font-family:Calibri;">make | use specified make [make]</span></p>
</td>
</tr><tr><td valign="top">
<p>--extra-cflags=ECFLAGS</p>
</td>
<td valign="top">
<p>添加<span style="font-family:Calibri;">ECFLAGS</span><span style="font-family:'宋体';">到</span><span style="font-family:Calibri;">CFLAGS | add ECFLAGS to CFLAGS []</span></p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p>--extra-ldflags=ELDFLAGS</p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p>添加<span style="font-family:Calibri;">ELDFLAGS</span><span style="font-family:'宋体';">到</span><span style="font-family:Calibri;">LDFLAGS</span><span style="font-family:'宋体';">（默认</span><span style="font-family:Calibri;">-Wl</span><span style="font-family:'宋体';">，</span><span style="font-family:Calibri;">--as-needed</span><span style="font-family:'宋体';">）</span><span style="font-family:Calibri;">|
 add ELDFLAGS to LDFLAGS [ -Wl,--as-needed]</span></p>
</td>
</tr><tr><td valign="top">
<p>--extra-libs=ELIBS</p>
</td>
<td valign="top">
<p>添加<span style="font-family:Calibri;">ELIBS | add ELIBS []</span></p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p>--build-suffix=SUFFIX</p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p>为专用程序添加后缀 <span style="font-family:Calibri;">| suffix for application specific build []</span></p>
</td>
</tr><tr><td valign="top">
<p>--arch=ARCH</p>
</td>
<td valign="top">
<p>选择机器架构（默认<span style="font-family:Calibri;">x86</span><span style="font-family:'宋体';">）</span><span style="font-family:Calibri;">select architecture [x86]</span></p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p>--cpu=CPU</p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p>选用最低的<span style="font-family:Calibri;">cpu</span><span style="font-family:'宋体';">（影响指令的选择，可以在老</span><span style="font-family:Calibri;">CPU</span><span style="font-family:'宋体';">上出错）</span><span style="font-family:Calibri;">| selects the minimum cpu required (affects
 instruction selection, may crash on older CPUs)</span></p>
</td>
</tr><tr><td valign="top">
<p>--powerpc-perf-enable</p>
</td>
<td valign="top">
<p>启用<span style="font-family:Calibri;">PPC</span><span style="font-family:'宋体';">上面的性能报告（需要启用</span><span style="font-family:Calibri;">PMC</span><span style="font-family:'宋体';">）</span><span style="font-family:Calibri;">enable performance report on PPC</span>(requires
 enabling PMC)</p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p>--disable-mmx</p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p>禁用<span style="font-family:Calibri;">MMX | disable MMX usage</span></p>
</td>
</tr><tr><td valign="top">
<p>--disable-armv5te</p>
</td>
<td valign="top">
<p>禁用<span style="font-family:Calibri;">armv5te | disable armv5te usage</span></p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p>--disable-iwmmxt</p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p>禁用<span style="font-family:Calibri;">iwmmxt | disable iwmmxt usage</span></p>
</td>
</tr><tr><td valign="top">
<p>--disable-altivec</p>
</td>
<td valign="top">
<p>禁用<span style="font-family:Calibri;">AltiVec | disable AltiVec usage</span></p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p>--disable-audio-oss</p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p>禁用<span style="font-family:Calibri;">OSS</span><span style="font-family:'宋体';">音频支持（默认启用）</span><span style="font-family:Calibri;">disable OSS audio support [default=no]</span></p>
</td>
</tr><tr><td valign="top">
<p>--disable-audio-beos</p>
</td>
<td valign="top">
<p>禁用<span style="font-family:Calibri;">BeOS</span><span style="font-family:'宋体';">音频支持（默认启用）</span><span style="font-family:Calibri;">disable BeOS audio support [default=no]</span></p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p>--disable-v4l</p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p>禁用<span style="font-family:Calibri;">video4linux</span><span style="font-family:'宋体';">提取（默认启用）</span><span style="font-family:Calibri;">disable video4linux grabbing [default=no]</span></p>
</td>
</tr><tr><td valign="top">
<p>--disable-v4l2</p>
</td>
<td valign="top">
<p>禁用<span style="font-family:Calibri;">video4linux2</span><span style="font-family:'宋体';">提取（默认启用）</span><span style="font-family:Calibri;">disable video4linux2 grabbing [default=no]</span></p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p>--disable-bktr</p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p>禁用<span style="font-family:Calibri;">bktr</span><span style="font-family:'宋体';">视频提取（默认启用）</span><span style="font-family:Calibri;">disable bktr video grabbing [default=no]</span></p>
</td>
</tr><tr><td valign="top">
<p>--disable-dv1394</p>
</td>
<td valign="top">
<p>禁用<span style="font-family:Calibri;">DV1394</span><span style="font-family:'宋体';">提取（默认启用）</span><span style="font-family:Calibri;">disable DV1394 grabbing [default=no]</span></p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p>--disable-network</p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p>禁用网络支持（默认支持）<span style="font-family:Calibri;">disable network support [default=no]</span></p>
</td>
</tr><tr><td valign="top">
<p>--disable-ipv6</p>
</td>
<td valign="top">
<p>禁用<span style="font-family:Calibri;">ipv6</span><span style="font-family:'宋体';">支持（默认支持）</span><span style="font-family:Calibri;">disable ipv6 support [default=no]</span></p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p>--disable-zlib</p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p>禁用<span style="font-family:Calibri;">zlib</span><span style="font-family:'宋体';">（默认支持）</span><span style="font-family:Calibri;">disable zlib [default=no]</span></p>
</td>
</tr><tr><td valign="top">
<p>--disable-simple_idct</p>
</td>
<td valign="top">
<p>禁用<span style="font-family:Calibri;">simple IDCT</span><span style="font-family:'宋体';">例程（默认启用）</span><span style="font-family:Calibri;">disable simple IDCT routines [default=no]</span></p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p>--disable-vhook</p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p>禁用<span style="font-family:Calibri;">video hooking</span><span style="font-family:'宋体';">支持</span><span style="font-family:Calibri;">| disable video hooking support</span></p>
</td>
</tr><tr><td valign="top">
<p>--enable-gprof</p>
</td>
<td valign="top">
<p>启用profiling with gprof [no]</p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p>--disable-debug</p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p>禁用调试符号 <span style="font-family:Calibri;">| disable debugging symbols</span></p>
</td>
</tr><tr><td valign="top">
<p>--disable-opts</p>
</td>
<td valign="top">
<p>禁用编译器最优化 <span style="font-family:Calibri;">| disable compiler optimizations</span></p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p>--disable-mpegaudio-hp</p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p>启用更快的解码<span style="font-family:Calibri;">MPEG</span><span style="font-family:'宋体';">音频（但精确度较低）（默认禁用）</span><span style="font-family:Calibri;">faster (but less accurate) MPEG audio decoding [default=no]</span></p>
</td>
</tr><tr><td valign="top">
<p>--disable-protocols</p>
</td>
<td valign="top">
<p>禁用 <span style="font-family:Calibri;">I/O </span><span style="font-family:'宋体';">协议支持（默认启用）</span><span style="font-family:Calibri;">disable I/O protocols support [default=no]</span></p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p>--disable-ffserver</p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p>禁用生成<span style="font-family:Calibri;">ffserver | disable ffserver build</span></p>
</td>
</tr><tr><td valign="top">
<p>--disable-ffplay</p>
</td>
<td valign="top">
<p>禁用生成<span style="font-family:Calibri;">ffplay | disable ffplay build</span></p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p>--enable-small</p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p>启用优化文件尺寸大小（牺牲速度）<span style="font-family:Calibri;">optimize for size instead of speed</span></p>
</td>
</tr><tr><td valign="top">
<p><span style="color:rgb(255,0,0);">--enable-memalign-hack</span></p>
</td>
<td valign="top">
<p><span style="color:rgb(255,0,0);">启用模拟内存排列，由内存调试器干涉？ <span style="font-family:Calibri;">
| emulate memalign, interferes with memory debuggers</span></span></p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p>--disable-strip</p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p>禁用剥离可执行程序和共享库 <span style="font-family:Calibri;">| disable stripping of executables and shared libraries</span></p>
</td>
</tr><tr><td valign="top">
<p>--disable-encoder=NAME</p>
</td>
<td valign="top">
<p>禁用<span style="font-family:Calibri;">XX</span><span style="font-family:'宋体';">编码器 </span>
<span style="font-family:Calibri;">| disables encoder NAME</span></p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p>--enable-encoder=NAME</p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p>启用<span style="font-family:Calibri;">XX</span><span style="font-family:'宋体';">编码器 </span>
<span style="font-family:Calibri;">| enables encoder NAME</span></p>
</td>
</tr><tr><td valign="top">
<p>--disable-decoder=NAME</p>
</td>
<td valign="top">
<p>禁用<span style="font-family:Calibri;">XX</span><span style="font-family:'宋体';">解码器 </span>
<span style="font-family:Calibri;">| disables decoder NAME</span></p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p>--enable-decoder=NAME</p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p>启用<span style="font-family:Calibri;">XX</span><span style="font-family:'宋体';">解码器 </span>
<span style="font-family:Calibri;">| enables decoder NAME</span></p>
</td>
</tr><tr><td valign="top">
<p>--disable-encoders</p>
</td>
<td valign="top">
<p>禁用所有编码器 <span style="font-family:Calibri;">| disables all encoders</span></p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p>--disable-decoders</p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p>禁用所有解码器 <span style="font-family:Calibri;">| disables all decoders</span></p>
</td>
</tr><tr><td valign="top">
<p>--disable-muxer=NAME</p>
</td>
<td valign="top">
<p>禁用<span style="font-family:Calibri;">XX</span><span style="font-family:'宋体';">混音器 </span>
<span style="font-family:Calibri;">| disables muxer NAME</span></p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p>--enable-muxer=NAME</p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p>启用<span style="font-family:Calibri;">XX</span><span style="font-family:'宋体';">混音器 </span>
<span style="font-family:Calibri;">| enables muxer NAME</span></p>
</td>
</tr><tr><td valign="top">
<p>--disable-muxers</p>
</td>
<td valign="top">
<p>禁用所有混音器 <span style="font-family:Calibri;">| disables all muxers</span></p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p>--disable-demuxer=NAME</p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p>禁用<span style="font-family:Calibri;">XX</span><span style="font-family:'宋体';">解轨器 </span>
<span style="font-family:Calibri;">| disables demuxer NAME</span></p>
</td>
</tr><tr><td valign="top">
<p>--enable-demuxer=NAME</p>
</td>
<td valign="top">
<p>启用<span style="font-family:Calibri;">XX</span><span style="font-family:'宋体';">解轨器 </span>
<span style="font-family:Calibri;">| enables demuxer NAME</span></p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p>--disable-demuxers</p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p>禁用所有解轨器 <span style="font-family:Calibri;">| disables all demuxers</span></p>
</td>
</tr><tr><td valign="top">
<p>--enable-parser=NAME</p>
</td>
<td valign="top">
<p>启用<span style="font-family:Calibri;">XX</span><span style="font-family:'宋体';">剖析器 </span>
<span style="font-family:Calibri;">| enables parser NAME</span></p>
</td>
</tr><tr><td valign="top" style="background:rgb(210,234,240);">
<p>--disable-parser=NAME</p>
</td>
<td valign="top" style="background:rgb(210,234,240);">
<p>禁用<span style="font-family:Calibri;">XX</span><span style="font-family:'宋体';">剖析器 </span>
<span style="font-family:Calibri;">| disables parser NAME</span></p>
</td>
</tr><tr><td valign="top">
<p>--disable-parsers</p>
</td>
<td valign="top">
<p>禁用所有剖析器 <span style="font-family:Calibri;">| disables all parsers</span></p>
</td>
</tr></tbody></table>


### Windows安装配置ffmpeg
参考链接：  
https://blog.csdn.net/chy466071353/article/details/54949221  

首先下载ffmpeg的windows版本https://ffmpeg.zeranoe.com/builds/

解压下载的压缩包，进入bin目录并获取路径。在此电脑界面下右击选择属性，选择高级系统设置。选择环境变量，在用户环境变量双击path，选择新建（注意不要更改其他环境变量），将刚才的bin路径粘贴进去，记得点下方的确定，再关闭当前窗口再点确定以保存。到这里，ffmpeg的配置就差不多了，调用命令行（windows+R输入cmd）输入“ffmpeg –version”，如果出现如下说明配置成功。


## <a id="6.2">FFmpeg命令行</a>
- [文件封装格式转换](#6.2.1)  
- [拉流存储](#6.2.2)
- [推流](#6.2.3)  
- [FFmpeg DASH/hls切片](#6.2.4)  
- [设置超时](#6.2.5)  
- [拉rtmp转rtsp](#6.2.6)  
- [修改比特率码率（-b）、帧率（-r）和文件大小（-fs）相关操作](#6.2.7)  


参考链接：  
1.ffmpeg 常用命令总结  
https://blog.csdn.net/weixin_42081389/article/details/100543007  

2.ffmpeg文档  
https://ffmpeg.org/ffmpeg-formats.html  

```cpp
FFmpeg命令行说明  
命令行基本格式如下：  
ffmpeg [global_options] {[input_file_options] -i input_url} ... {[output_file_options] output_url} ...  

常用参数说明：
主要参数：
-i 设定输入流 
-f 设定输出格式 
-ss 开始时间 
-re 按原始帧率推送
-f 输出流格式类型(flv,mp4等等)

视频参数：
-b 设定视频流量(码率)，默认为200Kbit/s 
-r 设定帧速率，默认为25 
-s 设定画面的宽与高 
-aspect 设定画面的比例 
-vn 不处理视频 
-vcodec 设定视频编解码器，未设定时则使用与输入流相同的编解码器

音频参数：
ar 设定采样率
ac 设定声音的Channel数
acodec 设定声音编解码器，未设定时则使用与输入流相同的编解码器an 不处理音频

```
FFmpeg DASH/hls切片
### <a id="6.2.1">文件封装格式转换</a>
参考链接：   
1.ffmpeg常见命令   
https://www.cnblogs.com/HongyunL/p/8120146.html   


#### 1.将mp4文件转换为flv文件
```js
ffmpeg  -i test.mp4  -c  copy  -f  flv  test.flv
-i 读取任意数量的输入文件(这些文件可以是正常文件、管道、网络流，抓取设备等)，写入任意数量的被声明为一个简单的输出文件名的文 件。在命令行的任何不能被解释的选项都被作为输出文件
-i test.mp4 输入文件是当前目录下的test.mp4文件
-c 编码方式，一般视频文件以h264编码、音频文件以aac编码居多
-c copy 拷贝输入文件的音视频编码方式到输出文件
-f flv 指定输出文件的封装方式为flv
```
#### 2.将flv文件转换为mp4文件
```js
ffmpeg  -i test.flv  -c  copy  -f  mp4  test.mp4
```
#### 3.将avi文件转换为mp4文件
```js
ffmpeg  -i test.avi  -c  copy  -f  mp4  test.mp4
```
#### 4.从mp4文件中提取h264
```js
ffmpeg -i test.mp4 -vcodec copy -an output.h264
-vcodec copy 拷贝原始视频的编码方式

ffmpeg -i test.mp4 -codec copy -bsf: h264_mp4toannexb -f h264 tmp.264  
-codec copy： 从mp4中拷贝  
-bsf: h264_mp4toannexb： 从mp4拷贝到annexB封装  
-an 取消音频
```
#### 5.将h264文件封装成mp4文件
```js
ffmpeg -i output.h264 -vcodec copy -f mp4 test.mp4
ffmpeg -i input_file -vcodec copy -an output_file_video　　//分离视频流
ffmpeg -i input_file -acodec copy -vn output_file_audio　　//分离音频流
```
#### 6.YUV序列转AVI
ffmpeg –s w*h –pix_fmt yuv420p –i input.yuv –vcodec mpeg4 output.avi  

#### 7.视频解复用
```js
ffmpeg –i test.mp4 –vcodec copy –an –f m4v test.264 

//解复用demuxer
ffmpeg -i input.mp4 -c:v copy –an output.264 
ffmpeg -i input.avi -c:v copy –an output.264
//封装muxer
ffmpeg -i input.264 -i <audio_file> -c:v copy c:a copy output.mp4
```


#### 8.视频转码
```js
ffmpeg –i test.mp4 –vcodec h264 –s 352*278 –an –f m4v test.264 //转码为码流原始文件
ffmpeg –i test.mp4 –vcodec h264 –bf 0 –g 25 –s 352*278 –an –f m4v test.264 //转码为码流原始文件
ffmpeg –i test.avi -vcodec mpeg4 –vtag xvid –qsame test_xvid.avi //转码为封装文件
-bf B帧数目控制
-g 关键帧间隔控制
-s 分辨率控制
ffmpeg –i video_file –i audio_file –vcodec copy –acodec copy output_file

//yuv
ffmpeg -i input.mp4 -ss 00:00:00 -to 00:00:10  -pix_fmt yuv420p output.yuv
ffmpeg -s w*h -pix_fmt yuv420p -r 30 -i input.yuv -c:v libx264 output.mp4
ffmpeg -s 1280x720 -pix_fmt yuv420p -r 30 -i input.yuv -c:v libx264 output.mp4

//libx264
ffmpeg -i input.mp4 -c:v libx264 -x264-param "level=30:bframes=0:cabac=0:ref=1:vbv-maxrate=768:vbv-bufsize=2000" -g 30 -b:v 1000k output.mp4 
ffmpeg -i input.mp4 -c:v libx264 -g 30 -crf 23 output.mp4
//libx265
ffmpeg -i input.mp4 -c:v libx265 -x265-param <param> -g 30 -b:v 1000k output.mp4
//硬解硬编（解码hevc_cuvid、h264_cuvid，编码hevc_nvenc、h264_nvenc）
ffmpeg -hwaccel cuvid -c:v hevc_cuvid -i input.mp4 -c:v hevc_nvenc -b:v 1000k -r 30 output.mp4
//硬解硬编、加filter（scale_cuda、resize、自定义cuda filter）
ffmpeg -hwaccel cuvid -c:v hevc_cuvid -i input.mp4 -vf scale_cuda=1280:720 -c:v hevc_nvenc output.mp4
//camera、v4l2、rtmp等
ffmpeg -re -i input.mp4 -f flv rtmp://myserver/live/mystream //-re 实时

```

#### 9.视频剪切
```js
ffmpeg –i test.avi –r 1 –f image2 image-%3d.jpeg //提取图片
ffmpeg -ss 0:1:30 -t 0:0:20 -i input.avi -vcodec copy -acodec copy output.avi //剪切视频
-r 提取图像的频率
-ss 开始时间
-t 持续时间

//时间上截取 （-ss <start> -to <end>）
ffmpeg -i input.mp4 -r 1 -f image2 image-%3d.jpeg  //提取图片,-r 提取图像的频率
ffmpeg -ss 00:01:30 -t 00:00:20 -i input.mp4 -c:v copy -c:a copy output.mp4    //剪切视频，-ss 开始时间，-t 持续时间
ffmpeg -ss 00:1:30 -to 00:01:50 -i input.mp4 -c:v copy -c:a copy output.mp4    //剪切视频，-ss 开始时间，-to 截止时间
//备注：如果开始时间和结束时间不在I帧上，直接copy可能会出现有一段时间没视频数据，画面变成黑色
ffmpeg -ss 00:1:30 -to 00:01:50 -i input.mp4 -c:v libx265 -c:a copy output.mp4
//空间上裁剪 -vf crop=out_w:out_h:start_point_w:start_point_h      
ffmpeg -i input.mp4 -vf crop=640:480:0:0 -c:v libx265  -crf 23 -c:a copy output640x480.mp4
//cropdetect:自动检测裁剪尺寸(自动去除边缘的黑部)
```

#### 10.YUV序列播放
ffplay -f rawvideo -video_size 1920x1080 input.yuv  

#### 11.分离视频音频流
ffmpeg -i input.mp4 -c:v copy -an output_video.mp4　　//-an 屏蔽audio 只提取出视频流   
ffmpeg -i input.mp4 -c:v copy -vn output_audio.mp4　　//-vn 屏蔽video 只提取出音频流 

#### 12.旋转、翻转
```js
//水平翻转输入视频(hflip、vflip)
ffmpeg -i in.avi -vf "hflip" out.avi
ffmpeg -i in.avi -vf "vflip" out.avi

//transpos
ffmpeg -i in.mov -vf "transpose=1" out.mov //Rotate 90 clockwise
ffmpeg -i in.mov -vf "transpose=2,transpose=2" out.mov //Rotate 180 degrees
0 = 90CounterCLockwise and Vertical Flip (default)
1 = 90Clockwise
2 = 90CounterClockwise
3 = 90Clockwise and Vertical Flip

//任意旋转视频角度（以弧度值表示）
//With 90 degrees equating with PI/2, you can do it like so:
ffmpeg -i in.mp4 -vf "rotate=PI/2" out.mp4
//for counter-clockwise the angle must be negative
ffmpeg -i in.mp4 -vf "rotate=-PI/2" out.mp4
//顺时针旋转PI/6:rotate=PI/6
```

#### 13.视频拼接
```js
//时间上拼接,视频文件切片合并 concat    
ffmpeg -i "concat:input1.mpg|input2.mpg|input3.mpg" -c copy output.mpg 
//或者 file_list.txt
cat file_list.txt
    # this is a comment
    file '/path/to/file1'
    file '/path/to/file2'
    file '/path/to/file3'
ffmpeg -f concat -i file_list.txt -c copy output.mp4

//空间上拼接 pad, overlay(叠加)
//pad=dst_w:dst_h:start_point_w:start_point_h
//overlay=start_point_w:start_point_h (默认为0)
//2 video to 2x1 video                                       
ffmpeg -i input_640x480_1.mp4 -i input_640x480_2.mp4 -filter_complex "[0:0]pad=iw*2:ih:0:0[a];[a][1:0]overlay=w" -libx265 output_1280x480.mp4 //iw,ih 输入视频的宽高，[0:0]->第一视频的第一个流，[1:0]->第二个视频的第一路流
ffmpeg -i input_640x480_1.mp4 -i input_640x480_2.mp4 -filter_complex "[0:0]pad=1280:480:0:0[a];[a][1:0]overlay=640" -libx265 output_1280x480.mp4
//4 video to 2x2 video
ffmpeg -i 1_640x480.mp4 -i 2_640x480.mp4 -i 3_640x480.mp4 -i 4_640x480.mp4 -filter_complex "[0:0]pad=iw*2:ih*2:0:0[a];[a][1:0]overlay=640:0[over1];[over1][2:0]overlay=0:480[over2];[over2][3:0]overlay=640:480" -c:v libx265 output_2x2_1280x960.mp4
```

#### 14.截屏
```js
可以通过ffmpeg直接抓取X11显示内容：
ffmpeg -f x11grab -video_size cif -framerate 25 -i :0.0+10,20 /tmp/out.mpg
//0.0 是X11服务的显示屏幕号(display.screen)， 定义于 DISPLAY 环境变量。 10是水平偏移， 20是垂直偏移
ffmpeg -f gdigrab -show_region 1 -framerate 6 -video_size cif -offset_x 10 -offset_y 20 -i desktop out.mpg
```

#### 15.two pass
ffmpeg -y -i input.mp4 -c:v libx264 -b:v 2600k -pass 1 -an -f mp4 /dev/null && \   
ffmpeg -i input.mp4 -c:v libx264 -b:v 2600k -pass 2 -c:a aac -b:a 128k output.mp4  

#### 16.插帧、升帧
ffmpeg -i input-30fps.mp4 -vf fps=fps=60 output-60fps.mp4   

#### 17.轨道分离、合并 (map)
```js
//音视频轨道分离，假设input.mp4有两个视频轨，1个音频轨
ffmpeg -i input.mp4 -map 0:0 -c:v copy output_stream1.mp4 -map 0:1 -c:v copy output_stream2.mp4 -map 0:3 -c:a copy output_audio.mp4 //0:0表示第一个输入视频的第一个视频流

//多个视频合成为一个具有多个轨道的视频
ffmpeg -i input_video_1.mp4 -i input_video_2.mp4 -i input_audio.mp4 -map 0:0:0 -c:v copy -map 1:0:0 -c:v copy -map 2:0:0 -c:a copy output_3track.mp4
```

### <a id="6.2.2">拉流存储</a>
#### 1.按照时间间隔存储
```js
ffmpeg -rtsp_transport tcp -i rtsp://42.101.40.177:10236/stream1 -r 10 -f image2 /root/images%09d.png -c copy -map 0 -f segment -segment_time 60 -segment_format mp4 "/root/out%03d.mp4" -rtsp_transport tcp 用tcp方式读取rtsp视频流
-r 10  10帧/秒
-f image2 输出文件的格式image2
-map 0 所有输入流
-f segment 分段持续时间
-segment_format mp4 输出文件的格式为mp4
```

#### 2.标准拉流存储
```js
ffmpeg -rtmp_app live -i rtmp://192.168.1.23:1935/live1 -c copy -f mp4 out.mp4
-rtmp_app live 指定输入的rtmp地址为直播流的形式
```

### <a id="6.2.3">推流</a>
####  参考链接
1.FFmpeg 推流总结  
https://www.jianshu.com/p/37ef34258608  

2.使用FFmpeg命令行进行UDP、RTP推流  
https://blog.csdn.net/zhoubotong2012/article/details/86711097  

#### 1.推送rtsp流到rtsp服务器
ffmpeg -i rtsp://192.168.1.23:554/stream/ -c copy -f rtsp rtsp://192.168.1.24:554/stream/  

#### 2.推送视频文件到rtsp服务器
ffmpeg -re -i test.mp4 -vcodec copy -codec copy -f rtsp rtsp://192.168.1. 24:554/stream/  

#### 3.推送rtmp流到rtmp服务器
ffmpeg -re -i rtmp://192.168.1.23:1935/live1 -vcodec copy -codec copy -f flv rtmp://192.168.1.24:1935/live1  

#### 4.推送视频文件到rtmp服务器
ffmpeg -re -i test.mp4 -c copy -f flv rtmp://192.168.1.23:1935/live1  

#### 5.推送rtsp到rtmp服务器
ffmpeg -i rtsp://192.168.1.23:554/live1 -c copy -f flv rtmp://192.168.1.23:1935/live1  

#### 6.推送rtmp流到rtsp服务器
ffmpeg -i rtmp://192.168.1.23:1935/live1-c copy -f rtsp rtsp://192.168.1.23:554/live1  

#### 7.ffmpeg+dss拉流分发
`环境 139.196.137.60 安装dss软件+ffmpeg软件`
* ffmpeg推流本地服务器mp4文件到dss软件  
在139.196.137.60服务器运行ffmpeg推流mp4到139.196.137.60上dss软件上，在/usr/local/movie下生成4.sdp文件
```shell
ffmpeg -re -i 20190329203822.mp4 -vcodec copy -codec copy -f rtsp rtsp://127.0.0.1:554/4.sdp 
``` 
播放rtsp://139.196.137.60:554/4.sdp进行播放    


* ffmpeg拉流rtsp流后推流到本地服务器到dss软件  
在139.196.137.60服务器运行ffmpeg拉流rtsp后推流到139.196.137.60上dss软件上，在/usr/local/movie下生成5.sdp文件 
```shell 
ffmpeg -rtsp_transport tcp -i rtsp://42.101.40.177:10236/stream1 -c copy -f rtsp rtsp://127.0.0.1:554/5.sdp  
```
播放rtsp://139.196.137.60:554/5.sdp进行播放   

>注意  
1.ffmpeg推流报错403可能是需要注意后rtsp地址不加引号。  
2.推流地址可能要写127.0.0.1

#### 8.FFmpeg命令UDP、RTP推流   
* 使用RTP发送H264    
ffmpeg -re -i d:\videos\1080P.264 -vcodec copy -f rtp rtp://127.0.0.1:1234       
我们可以让FFmpeg在执行推流输出时导出一个SDP，命令行如下：    
ffmpeg -re -i d:\videos\1080P.264 -vcodec copy -f rtp rtp://127.0.0.1:1234>test_rtp_h264.sdp   


* 使用UDP发送TS流     
FFmpeg的推流命令：      
ffmpeg -re -i d:\videos\1080P.264 -vcodec copy -f mpegts udp://127.0.0.1:1234     


* 使用RTP发送TS流   
很多人以为这种情况跟上面差不多，使用如下的推流命令（错误）：   
ffmpeg -re -i d:\videos\1080P.264 -vcodec copy -f mpegts rtp://127.0.0.1:1234    
但是实际上不行，我开始也使用该条命令，试过好多次老是失败，失败的原因是：发送的包缺少RTP头，输出的协议有错误。实际上，正确的命令是：  
ffmpeg -re -i d:\videos\1080P.264 -vcodec copy -f rtp_mpegts rtp://127.0.0.1:1234   


* 使用RTP分别发送音频流和视频流    
FFmpeg命令：   
ffmpeg  -re -i <media_file> -an -vcodec copy -f rtp rtp://<IP>:5004 -vn -acodec copy -f rtp rtp://<IP>:5005 > t    

* FFmpeg从视频文件中抽离视频并以udp+rtp+h264推流的命令   
ffmpeg -re -i /mnt/test/cuc_ieschool.flv -f h264 udp://192.168.110.243:12345  

* 发送H.264裸流至组播地址    
注：组播地址指的范围是224.0.0.0—239.255.255.255    
ffmpeg -re -i chunwan.h264 -vcodec copy -f h264 udp://233.233.233.223:6666    
注1：-re一定要加，代表按照帧率发送，否则ffmpeg会一股脑地按最高的效率发送数据。    
注2：-vcodec copy要加，否则ffmpeg会重新编码输入的H.264裸流。    

* 发送MPEG2裸流至组播地址    
ffmpeg -re -i chunwan.h264 -vcodec mpeg2video -f mpeg2video udp://233.233.233.223:6666   

### <a id="6.2.4">FFmpeg DASH/hls切片</a>
#### 1.hls切片
```cpp
命令：ffmpeg -i /home/videos/xxx.ts -c copy -f segment -segment_list_size 3 -segment_list /usr/local/nginx/html/xxx.m3u8 -segment_time 10 -active_window_size 10 -y /usr/local/nginx/html/xxx%3d.ts

说明：
-i 输入文件 -c copy 不编码
-f 文件格式，表示切片segment
-segment_list_size 切片列表中含有几个片，默认为所有
-segment_time 10 每个片的时间，单位为秒
-y 过程中产生同样文件直接覆盖
/usr/local/nginx/html/xxx.m3u8 生成的m3u8文件
/usr/local/nginx/html/xxx%3d.ts 切片文件存放路径
```

#### 2.dash切片
```cpp
命令：ffmpeg -i udp://10.0.224.28:1234 -c copy -f dash -window_size 5 -min_seg_duration 3000000 -single_file 0 -init_seg_name initavatar-stream\$RepresentationID\$.m4s -media_seg_name chunkavatar-stream\$RepresentationID\$-\$Number%05d\$.m4s -use_template 0 -bsf:a aac_adtstoasc ftp://user:password@192.168.32.188/liang/liangc.mpd
说明：

-i 输入文件 -c copy 不编码
-f 文件格式，表示切片dash
--window_size 5 实时更新只保留5个切片
-min_seg_duration 3000000 每个片的时间，单位为us
-single_file 0 是否是单个文件切片
-init_seg_name initavatar-stream$RepresentationID$.m4s 初始化切片文件，只第一次生成
-media_seg_name chunkavatar-stream$RepresentationID$-$Number%05d$.m4s切片文件，实时更新
-use_template 0 -bsf:a aac_adtstoasc 根据需求是否加上
ftp://user:password@192.168.32.188/liang/liangc.mpd 生成切片列表文件

window_size 默认值：int:0 — 取值范围：[0, int_max]
--清单中保留的最大段数

extra_window_size 默认值：int:5 — 取值范围：[0, int_max]
--从磁盘中删除之前保留在清单外部的最大段数

min_seg_duration 默认值：int64:5000000 取值范围：[0, int_max]
--最小段持续时间（以微秒为单位）
--默认值:5s

remove_at_exit默认值：bool:0 – 取值范围：[0, 1]
--完成后删除所有段

use_template默认值：bool:1 – 取值范围：[0, 1]
--使用SegmentTemplate而不是SegmentList
--如single_file:1 会被置0

use_timeline 默认值：bool:1 – 取值范围：[0, 1]
--在SegmentTemplate中使用SegmentTimeline
--manifest中startNumber、timescale与之相关

single_file默认值：bool:0 – 取值范围：[0, 1]
--将所有段存储在一个文件中，使用字节范围访问
--以单一文件存储：以byte range表示

single_file_name
--用于baseURL的DASH模板名称。意味着将single_file设置为“1”。

init_seg_name
--用于初始化段的DASH模板名称。默认为“init-stream $ RepresentationID $ .m4s”

media_seg_name
--用于媒体段的DASH模板名称。默认为“chunk-stream $ RepresentationID $ - $ Number％05d $ .m4s”

streaming streaming
--块输出模式的输出。在块流模式中，每个帧将是形成块的moof片段。

adaptation_sets
--将流分配给AdaptationSets。 语法是“id = x，streams = a，b，c id = y，streams = d，e”，其中x和y是适应集的ID，a，b，c，d和e是指数的索引。 映射流。 为了将所有视频（或音频）流映射到AdaptationSet，“v”（或“a”）可以用作流标识符而不是ID。 如果未定义任何分配，则默认为每个流的AdaptationSet。

timeout
--设置套接字I / O操作的超时。仅适用于HTTP输出。
```

#### 3.搭建dash直播
参考链接：  
1.搭建dash直播  
https://www.jianshu.com/p/512cb67e35d1  

搭建dash直播和hls直播差不多, 都是用nginx和nginx-rtmp-module
```cpp
rtmp {
    server {
        listen 1935;
        chunk_size 4096;
        
        application dash {
            live on;
            dash on;
            dash_path /home/movie/rtmp/dash;
        }
    }
}

ffmpeg是通过libxml2去解析mpd文件的, 所以在configure之前需要先安装libxml2
sudo apt-get install libxml2 
sudo apt-get install libxml2-dev
安装之后, 在configure的时候, 加上--enable-libxml2,在configure完成之后,查看config.h文件, 检查
CONFIG_DASH_DEMUXER宏是否为1.
然后make & make install.
最后用编译完成的ffplay测试下上面搭建的dash直播

```

### <a id="6.2.5">FFmpeg DASH/hls切片</a>
#### 1.设置rtsp超时
```cpp
AVDictionary* opts = NULL;
av_dict_set(&opts, "rtsp_transport", m_bTcp ? "tcp" : "udp", 0); //设置tcp or udp，默认一般优先tcp再尝试udp
av_dict_set(&opts, "stimeout", "3000000", 0);//设置超时3秒
int ret = avformat_open_input(&ctx, url, NULL, &opts);
```

#### 2.设置udp,http超时
```cpp
AVDictionary* opts = NULL;
av_dict_set(&opts, "timeout", "3000000", 0);//设置超时3秒
int ret = avformat_open_input(&ctx, url, NULL, &opts);
```

#### 3.设置av_read_frame 超时
```cpp
auto ctx = avformat_alloc_context();
ctx->interrupt_callback.callback = CheckInterrupt;//超时回调
ctx->interrupt_callback.opaque = this;
//
m_tStart = time(NULL);
av_read_frame(ctx, &pkt);
//超时回调函数
static int CheckInterrupt(void* ctx)
{
　　auto p = (xxx*)ctx;
　　return time(NULL) -  p->m_tStart >= 3 ? 1 : 0;//3秒超时
}
```

## <a id="6.3">FFmpeg函数</a>
- [1.av_dump_format](#6.3.1)

### <a id="6.3.1">1.av_dump_format</a>
```cpp
void av_dump_format(AVFormatContext *ic,
                    int index,
                    const char *url,
                    int is_output);

参数：
* Print detailed information about the input or output format, such as
 * duration, bitrate, streams, container, programs, metadata, side data,
 * codec and time base.
 *
 * @param ic        the context to analyze
 * @param index     index of the stream to dump information about
 * @param url       the URL to print, such as source or destination file
 * @param is_output Select whether the specified context is an input(0) or output(1)

此函数的作用：av_dump_format()是一个手工调试的函数，能使我们看到pFormatCtx->streams里面有什么内容。
一般接下来我们使用av_find_stream_info()函数，它的作用是为pFormatCtx->streams填充上正确的信息。
调用这个函数就可以看见流信息。
```

### <a id="6.2.6">拉rtmp转rtsp</a>
#模拟无人机推流文件到rtmp  无人机环境下（验证可以）   
ffmpeg -re -i /usr/movie/test.mp4 -f flv rtmp://221.229.219.225:18081/uav5/MP4   

推流rtmp到dss服务器 无人机环境（404有问题）   
ffmpeg -f flv -i rtmp://221.229.219.225:18081/uav5/MP4 -c copy -f rtsp rtsp://139.196.137.60:554/5.sdp    

推流文件到mediaserver  无人机环境（验证可以）   
ffmpeg -re -i /usr/movie/test.mp4 -c copy -f rtsp  -rtsp_transport tcp rtsp://139.196.137.60:554/live/test    

拉流无人机下rtmp推流到阿里云mediaserver（验证可以）   
ffmpeg -i rtmp://221.229.219.225:18081/uav5/MP4 -vcodec mpeg4 -s 1280x720 -f rtsp -rtsp_transport tcp rtsp://139.196.137.60:554/live/test     

PS：
1.推流rtmp出差由于没有设置宽高。
打开编码器输出流＃0.0时出错 - 可能是不正确的参数，如bit_rate，速率，宽度或高度(Error while opening encoder for output stream #0.0 - maybe incorrect parameters such as bit_rate, rate, width or height)。 

ffmpeg -i '/home/public_html/files/video_1355440448.m4v' -s '640x360' -sameq -ab '64k' -ar '44100' -f 'flv' -y /home/public_html/files/video_1355440448.flv     

ffmpeg -i C:\files\input\test.avi -y -ab 448k -ar 48000 -vcodec mpeg4 -s 640x480 -f flv C:\files\output\test.flv     


### <a id="6.2.7">修改比特率码率（-b）、帧率（-r）和文件大小（-fs）相关操作</a>
帧率：帧率（Frame rate）也叫帧频率，帧率是视频文件中每一秒的帧数，肉眼想看到连续移动图像至少需要15帧。

码率：比特率（Bit rate）(也叫码率，数据率)是一个确定整体视频/音频质量的参数，秒为单位处理的字节数，码率和视频质量成正比，在视频文件中中比特率用bps来表达。

#### 1.帧率
```cpp
1、用 -r 参数设置帧率
	ffmpeg –i input –r 25 output
2、用fps的filter设置帧率
	ffmpeg -i 1.mp4 -vf fps=fps=25 11.mp4

例如设置帧率为29.97fps，下面三种方式具有相同的结果：
	ffmpeg -i input.avi -r 29.97 output.mp4
	ffmpeg -i input.avi -r 30000/1001 output.mp4
	ffmpeg -i input.avi -r netsc output.mp4
```


#### 2.码率
```cpp
码率控制

码率控制对于在线视频比较重要。因为在线视频需要考虑其能提供的带宽。

那么，什么是码率？很简单： 
bitrate = file size / duration 
比如一个文件20.8M，时长1分钟，那么，码率就是： 
biterate = 20.8M bit/60s = 20.8*1024*1024*8 bit/60s= 2831Kbps 
一般音频的码率只有固定几种，比如是128Kbps， 
那么，video的就是 
video biterate = 2831Kbps -128Kbps = 2703Kbps。

设置参数-b
	ffmpeg -i 1.mp4 -b 1.5M 2.mp4
	
音频：-b:a     视频： - b:v
	设置视频码率为1500kbps
	ffmpeg -i input.avi -b:v 1500k output.mp4

```

#### 3.控制输出文件大小
```cpp
-fs (file size首字母缩写) 
	ffmpeg -i input.avi -fs 1024K output.mp4

计算输出文件大小
	(视频码率+音频码率) * 时长 /8 = 文件大小K
```

## <a id="6.4">FFmpeg使用注意点</a>
### ffmpeg open函数打开rtsp地址失败
ffmpeg open函数打开rtsp地址失败，导致获取视频信息失败。可能是采用了rtsp tcp方式需要采用tcp方式。

### ffmpeg 推流失败
1.ffmpeg推流报错403可能是需要注意后rtsp地址不加引号。  
2.推流地址可能要写127.0.0.1   

## <a id="6.5">Window集成ffmpeg环境搭建</a>
### 1.编译准备  
#### 1.1安装MinGW	    
MinGW(Minimalist GNU on Windows)：一个可自由使用和自由发布的Windows特定头文件和使用GNU工具集导入库的集合，允许你生成本地的Windows程序而不需要第三方C运行时库。  
安装过程如下：   
- 1.下载MinGW，下载地：http://sourceforge.net/projects/mingw/    
- 2.下载完mingw-get-setup.exe。点击运行exe程序，安装后，运行MinGW installer，安装如下内容：   
<img src="./image/6-3.png" style="zoom:100%" />

- 3.在Installation菜单下点击Apply Changes，完成。点击mingw-w64\msys\1.0\msys.bat，即可在弹出的窗口中进行linux命令行操作，cd到ffmpeg的源码目录.  
- 4.然后执行ffmpeg下configure命令。在弹出的窗口下gcc -v可以看到gcc版本，如果无效，可以尝试配置环境变量解决，将msys.bat配置到环境变量中。  

#### 1.2 安装YASM
- 1.下载YASM源码，下载地址：http://yasm.tortall.net/Download.html
- 2.解压yasm源码包，用mingw进入到yams目录下，运行./configure --prefix=/c/window_ffmpeg/yasm-1.3.0/build，进行配置结果到yasm/build目录中
- 3.然后运行make和make install两个命令，编译完成。
- 4.配置bin目录到系统环境下，可以在mingw窗口下如下配置：export PATH="$PATH:/c/window_ffmpeg/yasm-1.3.0/build/bin"。即可配置到系统路径下。配置完，可用yasm --verion验证是否安装成功。

#### 1.3 pkg-config
- 1.下载pkg-config源码，下载地址：https://www.freedesktop.org/wiki/Software/pkg-config/
- 2.解压pkg-config源码包，用mingw进入到pkg-config目录下，运行./configure --prefix=/c/window_ffmpeg/pkg-config-0.29/build，进行配置结果到pkg-config-0.29/build目录中
- 3.然后运行make和make install两个命令，编译完成。
- 4.配置bin目录到系统环境下，可以在mingw窗口下如下配置：export PATH="$PATH:/c/window_ffmpeg/pkg-config-0.29/build/bin"。即可配置到系统路径下。

### 2.编译ffmpeg
- 1.下载ffmpeg源码
下载地址：http://ffmpeg.org/download.html。
解压源码包。
- 2.在mingw窗口下，cd到ffmpeg目录下，运行./configure --prefix=/c/window_ffmpeg/ffmpeg/build --enable-shared  --enable-static --enable-debug。enable-debug开启ffmpeg的debug。
- 3.运行make&make install，完成编译
- 4.编译结果在build目录下。

### 3.Window集成使用ffmpeg
- 3.1安装VS IDE开发环境
	安装Visual Studio 2017 IDE环境，下载地址：https://visualstudio.microsoft.com/zh-hans/downloads/。下载完进行安装。
- 3.2 VS环境配置
 - 1.VS环境配置include和lib目录，alt+f7进入到项目属性，在VC++目录->包含目录中设置ffmpeg的include目录。在VC++目录->库目录中设置ffmpeg的lib目录，配置lib/include路径。
 - 2.vs工程下debug放入ffmpeg的dll文件，完成ffmpeg集成。
- 3.3 ffmpeg程序运行
写完ffmpeg测试程序，F5运行，如果“出现函数被声明为否决”，需要做如下设置可以解决：
<img src="./image/6-4.png" style="zoom:100%" />

如果无问题，即可在输出窗口看到运行结果和ffmpeg的日志信息。Ffmpeg运行结果和调试信息如下：
<img src="./image/6-5.png" style="zoom:100%" />

>以上方式为自己编译可以直接安装


## links
  * [目录](<音视频入门到精通目录.md>)