# 6.1Nginx
- [6.1Nginx简介](#6.1)
- [6.2编译安装](#6.2)

## <a id="6.1">6.1Nginx</a>
### 6.1 nginx
Nginx按照rtmp依赖rtmp模块。具体怎么按照可参考相关文档。    

参考连接   
1.https://mp.weixin.qq.com/s/qjUJKN2kt4iy_ytyk34rMg  

#### 6.1.1简介
Nginx 同 Apache 一样都是一种 Web 服务器。Apache 的发展时期很长，而且是毫无争议的世界第一大服务器。它有着很多优点：稳定、开源、跨平台等等。它出现的时间太长了，它兴起的年代，互联网产业远远比不上现在。所以它被设计为一个重量级的。它不支持高并发的服务器。在 Apache 上运行数以万计的并发访问，会导致服务器消耗大量内存。操作系统对其进行进程或线程间的切换也消耗了大量的 CPU 资源，导致 HTTP 请求的平均响应速度降低。  
Nginx 使用基于事件驱动架构，使得其可以支持数以百万级别的 TCP 连接。  
高度的模块化和自由软件许可证使得第三方模块层出不穷（这是个开源的时代啊）。  
Nginx 是一个跨平台服务器，可以运行在 Linux、Windows、FreeBSD、Solaris、AIX、Mac OS 等操作系统上。这些优秀的设计带来的极大的稳定性。  

- 关于代理
所谓代理就是一个代表、一个渠道；此时就涉及到两个角色，一个是被代理角色，一个是目标角色。被代理角色通过这个代理访问目标角色完成一些任务的过程称为代理操作过程；如同生活中的专卖店，客人到 adidas 专卖店买了一双鞋，这个专卖店就是代理，被代理角色就是 adidas 厂家，目标角色就是用户。  

- 正向代理
在如今的网络环境下，我们如果由于技术需要要去访问国外的某些网站，此时你会发现位于国外的某网站我们通过浏览器是没有办法访问的。
此时大家可能都会用一个操作 FQ 进行访问，FQ 的方式主要是找到一个可以访问国外网站的代理服务器，我们将请求发送给代理服务器，代理服务器去访问国外的网站，然后将访问到的数据传递给我们！正向代理最大的特点是客户端非常明确要访问的服务器地址；服务器只清楚请求来自哪个代理服务器，而不清楚来自哪个具体的客户端；正向代理模式屏蔽或者隐藏了真实客户端信息。  
客户端必须设置正向代理服务器，当然前提是要知道正向代理服务器的 IP 地址，还有代理程序的端口。正向代理，"它代理的是客户端"，是一个位于客户端和原始服务器（Origin Server）之间的服务器，为了从原始服务器取得内容，客户端向代理发送一个请求并指定目标（原始服务器）。然后代理向原始服务器转交请求并将获得的内容返回给客户端。客户端必须要进行一些特别的设置才能使用正向代理。  
正向代理的用途：  
访问原来无法访问的资源，如 Google。  
可以做缓存，加速访问资源。  
对户端访问授权，上网进行认证。  
代理可以记录用户访问记录（上网行为管理），对外隐藏用户信息。 

- 反向代理
举例如我国的某宝网站，每天同时连接到网站的访问人数已经爆表，单个服务器远远不能满足人民日益增长的购买欲望了。  
此时就出现了一个大家耳熟能详的名词：分布式部署；也就是通过部署多台服务器来解决访问人数限制的问题。  
某宝网站中大部分功能也是直接使用 Nginx 进行反向代理实现的，并且通过封装 Nginx 和其他的组件之后起了个高大上的名字：Tengine。  
多个客户端给服务器发送的请求，Nginx 服务器接收到之后，按照一定的规则分发给了后端的业务处理服务器进行处理了。   
此时请求的来源也就是客户端是明确的，但是请求具体由哪台服务器处理的并不明确了，Nginx 扮演的就是一个反向代理角色。    
客户端是无感知代理的存在的，反向代理对外都是透明的，访问者并不知道自己访问的是一个代理。因为客户端不需要任何配置就可以访问。  
反向代理，"它代理的是服务端"，主要用于服务器集群分布式部署的情况下，反向代理隐藏了服务器的信息。  
反向代理的作用：  
保证内网的安全，通常将反向代理作为公网访问地址，Web 服务器是内网。  
负载均衡，通过反向代理服务器来优化网站的负载。  

- 负载均衡  
请求数量按照一定的规则进行分发，到不同的服务器处理的规则，就是一种均衡规则。所以将服务器接收到的请求按照规则分发的过程，称为负载均衡。  
负载均衡在实际项目操作过程中，有硬件负载均衡和软件负载均衡两种，硬件负载均衡也称为硬负载，如 F5 负载均衡，相对造价昂贵成本较高。  
Nginx 支持的负载均衡调度算法方式如下：  

```Go
①weight 轮询（默认）：接收到的请求按照顺序逐一分配到不同的后端服务器，即使在使用过程中，某一台后端服务器宕机，Nginx 会自动将该服务器剔除出队列，请求受理情况不会受到任何影响。
这种方式下，可以给不同的后端服务器设置一个权重值（weight），用于调整不同的服务器上请求的分配率。
权重数据越大，被分配到请求的几率越大；该权重值，主要是针对实际工作环境中不同的后端服务器硬件配置进行调整的。
②ip_hash：每个请求按照发起客户端的 ip 的 hash 结果进行匹配，这样的算法下一个固定 ip 地址的客户端总会访问到同一个后端服务器，这也在一定程度上解决了集群部署环境下 Session 共享的问题。
③fair：智能调整调度算法，动态的根据后端服务器的请求处理到响应的时间进行均衡分配。
响应时间短处理效率高的服务器分配到请求的概率高，响应时间长处理效率低的服务器分配到的请求少，它是结合了前两者的优点的一种调度算法。
但是需要注意的是 Nginx 默认不支持 fair 算法，如果要使用这种调度算法，请安装 upstream_fair 模块。
④url_hash：按照访问的 URL 的 hash 结果分配请求，每个请求的 URL 会指向后端固定的某个服务器，可以在 Nginx 作为静态服务器的情况下提高缓存效率。
同样要注意 Nginx 默认不支持这种调度算法，要使用的话需要安装 Nginx 的 hash 软件包。
```

#### 6.1.2 几种常用 Web 服务器对比

<img src="./image/2-144.png" style="zoom:100%" />

## <a id="6.2">6.2编译安装</a>
此次主要记录CentOS7 搭建Nginx-rtmp流媒体服务。  
### 1.准备工作
准备安装所需编译依赖工具：  
yum -y install gcc：安装gcc编译工具.    
yum install -y pcre pcre-devel：安装pcre：pcre是一个perl库，包括perl兼容的正则表达式库，nginx的http模块使用pcre来解析正则表达式所以需要安装pcre库。     
yum install -y zlib zlib-devel：zlib库提供了很多种压缩和解压缩方式nginx使用zlib对http包的内容进行gzip。     
yum install -y openssl openssl-devel：安装rtmp模块需要用到opensll模块。如果命令行安装失败，可以用源码编译。https://www.openssl.org/source/（https://github.com/openssl/openssl）下载。  

cd openssl  
./config --prefix=/usr/local/ssl --openssldir=/usr/local/ssl shared zlib    

Make&make test&make install     
直接config后会将openssl安装到默认文件夹下。Nginx使用opensll可能遇到以下问题：  
<img src="./image/6-1.png" style="zoom:100%" />

ln -s /usr/local/lib64/libssl.so.1.1 /usr/lib64/libssl.so.1.1   
ln -s /usr/local/lib64/libcrypto.so.1.1 /usr/lib64/libcrypto.so.1.1   

### 2.编译使用
下载 nginx 和 nginx-rtmp源码。比如：  
wget http://nginx.org/download/nginx-1.7.5.tar.gz  
wget https://github.com/arut/nginx-rtmp-module/archive/master.zip  

压缩包解压 tar -zxvf 后，到nginx目录下，运行：   
./configure --add-module=/home/athnkk/project/mediaStream/rtmp-module --with-http_ssl_module--with-openssl=源码路径
make&make install。  

安装到/usr/local/nginx/sbin下面。   
如果需要支持rtmp功能需要修改/usr/local/nginx/conf文件夹下nginx.conf文件。在http后面增加   
```shell
rtmp {                #RTMP服务
    server {
       listen 1935;  #//服务端口
       chunk_size 4096;   #//数据传输块的大小
       application vod {
           play /opt/video; #//视频文件存放位置。
       }
       application live{ #直播
           live on;
       }
   }
}
```
即可使用   

ngingx操作：  
./nginx -s stop 停止原来的Nginx服务  
./nginx -t  查询  
./nginx  启动  
sudo service nginx restart 重新启动nginx服务   
nginx -s reload 重新运行   
ps -ef | grep nginx  查看nginx服务是否启动成功   

编辑开机运行  
cd /etc/init.d/   
vi nginx   
//注册成服务   
chkconfig --add nginx   
//重启, 查看nginx服务是否自动启动.   
shutdown -h0 -r   
netstat -apn|grep nginx   

如果你使用了防火墙，请允许端口 tcp 1935  
用netstat -an | grep 1935  
如果启动过程中遇到端口被占用。查看端口PID，lsof -i tcp:8080 根据端口PID, kill掉(这儿的9603换成你自己8080端口的PID)，kill 9603。  
启动后可以在浏览器打开ip查看是否启动成功。  
点播时候，vlc播放地址为：rtmp://127.0.0.1/vod/VID20190428170440.mp4就可以播放   

### 3.注意
不能播放看看conf文件端口号，端口是否通得，防火墙配置，telnet端口，阿里云需要在控制台设置。  
参考链接：  
1.openssl安装  
https://blog.csdn.net/weixin_42037232/article/details/88049210  



## links
  * [目录](<音视频入门到精通目录.md>)